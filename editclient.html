<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title>Facturation Club Judo Anjou: Judoka</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <link rel="shortcut icon" href="/files/favicon.ico" type="image/x-icon" />
  <style type="text/css" media="all">@import "styles.css";</style>
</head>

<body>

<script type="text/javascript"  src="gears_init.js"></script>
<script type="text/javascript"  src="constants.js"></script>
<script type="text/javascript"  src="datastore.js"></script>
<script type="text/javascript"  src="base.js"></script>
<script type="text/javascript"  src="utils.js"></script>
<script type="text/javascript"  src="cookie.js"></script>

<h1>Renseignements judoka</h1>
<div><span id="status">&nbsp;</span>

<form name="client" onSubmit="handleSubmit(); return false;">
<input type="hidden" id="cid" value="" />

<div class="sectionBody">

<fieldset> <legend>Identit&eacute;</legend>
 <div>
  <div style="float:left"><label for="nom">Nom</label><input id="nom" type="text" size="24" value="" maxlength="50"></div>
  <div style="float:right"><label for="prenom">Prenom</label><input id="prenom" type="text" size="24" value="" maxlength="50"></div>
 </div>
 <div style="clear:both">
  <label for="ddn">Date de naissance<br />(aaaa-mm-jj)</label>
  <input id="ddn" type="text" size="24" value="" maxlength="50" onChange="ddnChange()"></div>
 </div>
</fieldset>

<fieldset> <legend>Adresse</legend>
 <div>
  <div>
   <div style="float:left">
    <label for="adresse">Adresse</label>
    <input id="adresse" type="text" size="30" value="" maxlength="80">
   </div>
   <div style="float:right">
    <label for="ville">Ville</label>
    <input id="ville" type="text" size="24" value="" maxlength="50">
   </div>
  </div>
  <div>
   <div style="float:left">
    <label for="tel">T&eacute;l&eacute;phone(s)</label>
    <input id="tel" type="text" size="30" value="" maxlength="20">
   </div>
   <div style="float:right">
    <label for="courriel">Courriel</label>
    <input id="courriel" type="text" size="24" value="" maxlength="255">
   </div>
  </div>
 </div>
</fieldset>

 <fieldset> <legend>Autres renseignments</legend>
 <div>
  <div>
   <div style="float:left"><label for="affiliation">N<sup>o</sup> Judo Qu&eacute;bec</label>
   <input id="affiliation" type="text" size="10" value="" maxlength="20"></div>
   <div style="float:right" ><label for="carte_anjou">N<sup>o</sup> arrondissement Anjou</label>
   <input id="carte_anjou" type="text" size="24" value="" maxlength="20" onChange="updateCarteAnjou()"></div>
  </div>
  <div style="clear:both">
   <div style="float:left"><label for="grade">Grade judo</label>
   <input id="grade" type="text" size="10" value="" maxlength="20" onChange="updateCategorie()"></div>
   <div style="float:right"> <label for="date_grade">Date du grade</label>
   <input id="date_grade" type="text" size="24" value="" maxlength="20"></div>
  </div>
  <div style="clear:both">
   <label for="nom_recu_impot">Nom re&ccedil;u imp&ocirc;t</label>
   <input id="nom_recu_impot" type="text" size="30" value="" maxlength="50"> 
  </div>
 </fieldset>

 <fieldset> <legend>Urgence</legend>
  <div>
    <label for="no_RAMQ">N<sup>o</sup> RAMQ</label>
    <input id="RAMQ" type="text" size="20" value="" maxlength="20">
  </div>
  <div>
   <div style="float:left"><label for="nom_contact_urgence">Contact en cas d'urgence</label>
    <input id="nom_contact_urgence" type="text" size="30" value="" maxlength="50"></div>
   <div style="float:right"><label for="tel_contact_urgence">T&eacute;l&eacute;phone urgence</label>
    <input id="tel_contact_urgence" type="text" size="24" value="" maxlength="50"></div>
  </div>
 </fieldset>

 <fieldset> <legend>Frais</legend>
  <div>
   <div style="float:left">
    <label for="categorie">Cat&eacute;gorie d'&acirc;ge</label>
    <input id="categorie" type="text" value="" onChange="calcFrais()" readonly>
   </div>
   <div style="float:right">
    <label for="sessions">Sessions</label>
    <select id="sessions" onChange="calcFrais()">
    <option value="1">1</option>
    <option value="2">2</option>
    </select>
   </div>
  </div>
  <div>
   <div style="float:left; padding-bottom:1em;">
    <label for="cours">Cours</label>
    <select id="cours">
    </select>
   </div>
   <div style="float:right">
    <label for="escompte">Escompte</label>
    <select id="escompte" onChange="calcFrais()">
    </select>
   </div>
  </div>
  <div style="clear:both; padding-bottom:2em;">
   <div style="float:left">
    <label for="judogi">Co&ucirc;t judogi</label>
    <input id="judogi" type="text" size="5" value="" onChange="addDollars('judogi'); calcFrais()">
   </div>
   <div style="float:left; padding-left:25%">
    <label for="passeport">Passeport Judo Qu&eacute;bec</label>
    <input id="passeport" type="checkbox" onChange="calcFrais()">
   </div>
   <div style="float:right">
    <label for="non_anjou">Pas de carte Anjou</label>
    <input id="non_anjou" type="checkbox" onChange="calcFrais()" readonly>
   </div>
  </div>
  <div style="clear:both">
   <label for="cas_special_note">Cas sp&eacute;cial</label>
   <input id="cas_special_note" type="text" value="" onChange="enableCustomFrais()">
  </div>
  <div>
   <label for="horaire_special">Horaire sp&eacute;cial</label>
   <input id="horaire_special" type="text" value="" onChange="calcFrais()" >
  </div>
  <div>
   <label for="frais">Frais</label>
   <input id="frais" type="text" value="" readonly>
  </div>
 </fieldset>

 <input id="version" type="hidden" value="">
 <input id="server_version" type="hidden" value="-1">
 <input id="server_id" type="hidden" value="-1">

 <input id="date_inscription" type="hidden" value="">

 <div class="actions">
 <div style="float:left; text-align:right;">
  <a href="clients.html" onClick="handleSubmit()">Sauvegarder et retourner</a>
  <a href="clients.html" onClick="handleSubmit(); return false">Sauvegarder</a>
 </div>
 <div style="float:right; text-align:right;">
  <a href="clients.html" onClick="return handleDelete();">Supprimer</a>
  <span style="padding-right:10em">&nbsp;</span>
  <a href="clients.html">Annuler</a>
 </div>
 </div>
</form>

<script>
// Courtesy http://www.netlobo.com/url_query_string_javascript.html
function gup( name )
{
  name = name.replace(/[\[]/,"\\\[").replace(/[\]]/,"\\\]");
  var regexS = "[\\?&]"+name+"=([^&#]*)";
  var regex = new RegExp( regexS );
  var results = regex.exec( window.location.href );
  if( results == null )
    return null;
  else
    return results[1];
}

var cid;

// First try the cookie; then override with the GET parameter.
cid = readCookie("cid");

var cc = gup("cid"); if (cc != null) cid = cc;

var catId;
var db;

store = new DataStore();
store.init();
localInit();

function localInit() {
  if (cid)
    populateClient(cid);
  populateCoursEscomptes();
  calcFrais();
  enableCustomFrais();
  clearStatus();
}

function populateClient() {
  var rs = executeToObjects(db, 'select * from `client` where id = ?', [cid])[0];
  if (!rs) { addStatus('cid not found'); return; }

  for (i = 0; i < ALL_FIELDS.length; i++) {
    key = ALL_FIELDS[i];
    getElementById(key).value = rs[key];
  }

  var rs = executeToObjects(db, 'select grade, date_grade from `grades` where client_id = ?', [cid])[0];
  if (rs) {
    getElementById('grade').value = rs['grade'];
    getElementById('date_grade').value = rs['date_grade'];
  }

  updateCategorie();

  var rs = executeToObjects(db, 'select * from `services` where client_id = ?', [cid])[0];
  if (rs) {
    for (i = 0; i < SERVICE_FIELDS.length; i++) {
      key = SERVICE_FIELDS[i];
      getElementById(key).value = rs[key];
    }
  }
  addDollars('frais'); addDollars('judogi');
}

function populateCoursEscomptes() {
  var cours = getElementById('cours');
  for (i = 0; i < COURS.length; i++) {
    cours.add(new Option(COURS[i], i), null);
  }

  var escompte = getElementById('escompte');
  for (i = 0; i < ESCOMPTE_NAMES.length; i++) {
    escompte.add(new Option(ESCOMPTE_NAMES[i], ESCOMPTE_AMOUNTS[i]), null);
  }
}

function updateCarteAnjou() {
  getElementById("non_anjou").value = 
		  (getElementById("carte_anjou").value == '');
}

function addDollars(id) {
  var v = getElementById(id).value;
  if (v == '') return;

  stripDollars(id);
  getElementById(id).value += ' $';
}

function stripDollars(id) {
  var v = getElementById(id).value;
  if (v == '') return;

  if (v.substring(v.length-1, v.length) == '$')
    v = v.substring(v, v.length-1);
  getElementById(id).value = v.trim();
}

function calcFrais() {
  if (getElementById("cas_special_note").value != "")
    return;

  var basePrice;
  if (getElementById("sessions").value == '1')
    basePrice = categoryPrix1(catId);
  else
    basePrice = categoryPrix2(catId);

  var escompte = parseFloat(getElementById("escompte").value);
  basePrice = basePrice * (1.00-(escompte/100));

  // for winter, should be able to selectively pay judoQC.
  basePrice += categoryPrixJQ(catId);
  if (getElementById("passeport").checked)
    basePrice += FRAIS_PASSEPORT_JUDO_QUEBEC;
  if (getElementById("non_anjou").checked)
    basePrice += FRAIS_PAS_ANJOU;

  var jv = getElementById("judogi").value;
  jv = jv.substring(0, jv.length-1);
  if (parseFloat(jv) > 0)
    basePrice += parseFloat(jv);

  getElementById("frais").value = asCurrency(basePrice)+" $";
}

function enableCustomFrais() {
  // XXX put up warning when erasing note and already have frais.
  getElementById("frais").readOnly = 
    (getElementById("cas_special_note").value == "");
}

function handleSubmit() {
  var rs = {};

  stripDollars('frais'); stripDollars('judogi');

  var f = ALL_FIELDS.concat(SERVICE_FIELDS);
  for (i = 0; i < f.length; i++) {
    var key = f[i];
    rs[key] = getElementById(key).value;
  }

  rs.version++; getElementById("version").value = rs.version;

  cid = storeOneClient(cid, rs);

  addDollars('frais'); addDollars('judogi');

  clearStatus(); addStatus("Sauvegardé."); setTimeout('clearStatus()', 3000);
}

function handleDelete() {
  if (!confirm ("Êtes-vous certain de vouloir supprimer "+
                getElementById("prenom").value+" "+
                getElementById("nom").value+"?"))
    return false;

  db.execute('DELETE FROM `client` WHERE id=?', [cid]);
  return true;
}

var oldDDN = getElementById("ddn").value;
function ddnChange() {
  var ddn = getElementById("ddn").value;
  if (validateDate(ddn)) {
    updateCategorie(); 
    clearStatus();
  }
  else {
    getElementById("ddn").value = oldDDN;
    setError("Date de naissance invalide.");
    setTimeout(function () { getElementById("ddn").focus(); }, 1);
  }
  oldDDN = ddn;
}

function updateCategorie() {
  var c = getElementById("categorie");
  var y = parseInt(getElementById("ddn").value.substring(0,4));
  var grade = getElementById("grade").value;
  catId = computeCategoryId(y, grade);
  c.value = categoryName(catId);
}
</script>

</body>

</html>
