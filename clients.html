<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title>Facturation Club Judo Anjou: Recherche judoka</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <link rel="shortcut icon" href="/files/favicon.ico" type="image/x-icon" />
  <style type="text/css" media="all">@import "styles.css";</style>
</head>

<body>

<script type="text/javascript" src="gears_init.js"></script>
<script type="text/javascript" src="constants.js"></script>
<script type="text/javascript" src="datastore.js"></script>
<script type="text/javascript" src="xhr.js"></script>
<script type="text/javascript" src="base.js"></script>
<script type="text/javascript" src="utils.js"></script>
<script type="text/javascript" src="md5.js"></script>

<h1>Recherche judoka</h1>
<p><span id="status">&nbsp;</span>

<script>
var db;

store = new DataStore();
store.init();
clearStatus();

var clients = [];
var firstToDisplay = 0;

function refreshResults() {
  var resultBox = getElementById('results');
  resultBox.innerHTML = '';
  for (var i = firstToDisplay; i < min(firstToDisplay+10, clients.length); ++i) {
    resultBox.innerHTML += '<a href="editclient.html?cid='+clients[i].id+'">'+clients[i].nom+', '+clients[i].prenom+'</a><br />';
  }

  if (firstToDisplay > 0 || firstToDisplay + 10 < clients.length) 
    resultBox.innerHTML += '<br />';

  if (firstToDisplay > 0)
    resultBox.innerHTML += '<a href="" onClick="firstToDisplay -= 10; refreshResults(); return false;">Résultats précedents</a>&nbsp;';
  if (firstToDisplay + 10 < clients.length)
    resultBox.innerHTML += '<a href="" onClick="firstToDisplay += 10; refreshResults(); return false;">Résultats suivants<a>';
}

function doSearch() {
  var f = '%'+getElementById('query').value+'%';
  var rs = db.execute('SELECT id, nom, prenom FROM `client` WHERE prenom||" "||nom LIKE ? OR nom||" "||prenom LIKE ? ORDER BY nom COLLATE NOCASE', [f, f]);
  var index = 0;
  clients = [];
  while (rs.isValidRow()) {
    clients[index] = {};
    clients[index].id = rs.field(0);
    clients[index].nom = rs.field(1);
    clients[index].prenom = rs.field(2);
    ++index;
    rs.next();
  }
  rs.close();

  firstToDisplay = 0;
  refreshResults();
}

var challenge;

function loginAndSync() {
  doRequest("GET", "authenticate.php", null, lsCheckLogin_, null);

  function lsCheckLogin_(status, statusText, responseText, responseXML) {
    if (status == '200') {
      store.sync();
      return;
    }
    doRequest("GET", "request_challenge.php", null, lsGotChallenge_, null);
  }

  function lsGotChallenge_(status, statusText, responseText, responseXML) {
    challenge = responseText.trim();
    getElementById('login').style.display="inline";
    getElementById('login').onSubmit = function() { 
        getElementById('login').style.display="none";
        store.sync();
    }
    return;
  }
}

function computeResponse() {
  postReq = "username="+getElementById('loginid').value+"&";
  postReq += "response="+
    hex_md5(challenge+getElementById('password').value);
  return postReq;
}

function doLogin(arg, successContinuation) {
  doRequest("POST", "authenticate.php", null, lAuthenticated_, arg);
  function lAuthenticated_(status, statusText, responseText, responseXML) {
    if (status == '200') {
      successContinuation();
    } else {
      setError("Mot de passe invalide.");
      setTimeout(clearStatus, 1000);
    }
  }
}
</script>

<div id="sync" onClick="loginAndSync()">synchroniser</div></div></p>

<form name="findclient" action="#">
<div class="sectionBody" style="padding:7px 0 9px 7px;">
 <div style="padding:10px 10px 0px 10px;">
 <div>
  <span class="standardtitle">Nom ou Prenom</span><br />
  <div><input id="query" type="text" size="60" value="" maxlength="60"></div>
 </div>
 <input type="submit" value="Recherche" onClick="doSearch(); return false;"/>
 <input type="button" value="Nouvelle client" onClick="location.href='editclient.html';"/>
</form>

<div id="results" style="padding-top:1em">
</div>

<div id="login" style="display:none">
<form action="#">
  Veuillez vous identifier: <br /><br />
  <div><label for="loginid">id</label>
  <input id="loginid" type="text" size="16" value="" maxlength="50"></div>
  <div><label for="password">mot de passe</label>
  <input id="password" type="password" size="16" value="" maxlength="50"></div>
  <div class="actions">
   <a onClick="doLogin(computeResponse(), getElementById('login').onSubmit)">entrer</a> &nbsp; &nbsp; 
   <a onClick="getElementById('login').style.display='none'">annuler</a>
  </div>
</form>
</div>

</body>

</html>

